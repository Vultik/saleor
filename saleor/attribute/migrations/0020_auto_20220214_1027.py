# Generated by Django 3.2.12 on 2022-02-14 10:27

from django.db import migrations


def fetch_reference_id_from_slug(slug):
    x = slug.split("_")[1]
    return x


def import_attribute_values(apps, schema):
    AttributeValue = apps.get_model("attribute", "AttributeValue")
    Page = apps.get_model("page", "Page")
    Product = apps.get_model("product", "Product")

    for attribute_value in AttributeValue.objects.iterator():
        if attribute_value.attribute.entity_type == "Page":
            page_id = Page.objects.filter(
                pk=fetch_reference_id_from_slug(attribute_value.slug)
            )[0]
            if page_id:
                attribute_value.reference_page = page_id
                attribute_value.save(update_fields=["reference_page"])
            else:
                attribute_value.delete()
        elif attribute_value.attribute.entity_type == "Product":
            product_id = Product.objects.filter(
                pk=fetch_reference_id_from_slug(attribute_value.slug)
            )[0]
            if product_id:
                attribute_value.reference_page = product_id
                attribute_value.save(update_fields=["reference_product"])
            else:
                attribute_value.delete()
        else:
            continue


class Migration(migrations.Migration):

    dependencies = [
        ("attribute", "0019_auto_20220214_1025"),
    ]

    operations = [
        migrations.RunPython(
            import_attribute_values,
            migrations.RunPython.noop,
        )
    ]
